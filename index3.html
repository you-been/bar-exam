<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuaggaJS 바코드 스캐너</title>
    <style>
    body {
        background: #f8f8f8;
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.2em;
    }

    #buttonContainer {
        display: flex;
        margin-bottom: 30px;
    }

    button {
        background: #999;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 25px;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    button:hover {
        background: #ddd;
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    #scanner-container {
        position: relative;
        width: 85%;
        height: 480px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    #scanner-container video {
        width: 100% !important;
        height: auto !important;
        border-radius: 10px;
        display: block;
        position: relative;
    }

    #scanner-container canvas {
        position: absolute !important;
        top: 30px !important;
        left: 30px !important;
        right: 30px !important;
        bottom: auto !important;
    }

    #scanner-container canvas.drawingBuffer {
        z-index: 2;
    }

    #selectedImageContainer {
        margin-top: 10px;
    }

    #status {
        text-align: center;
        color: black;
        margin-top: 20px;
        font-size: 18px;
        font-weight: 500;
        min-height: 30px;
    }

    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
        }

        #scanner-container {
            border-radius: 10px;
        }
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>바코드 스캐너</h1>
        <div id="buttonContainer">
            <button id="startButton" onclick="startScanner()">시작</button>
            <button id="stopButton" onclick="stopScanner()" class="hidden">종료</button>
        </div>
        <div id="scanner-container"></div>
        <div id="status"></div>
        <div id="selectedImageContainer"></div>
    </div>
    <script>
    var scannerIsRunning = false;
    var previousBarcode = "";
    var consecutiveMatches = 0;
    var targetMatches = 5;

    function updateStatus(message) {
        document.getElementById("status").textContent = message;
    }

    function startScanner() {
        if (!scannerIsRunning) {
            updateStatus("카메라를 준비하는 중...");

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                locator: {
                    patchSize: "large",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 5,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locate: true
            },
            function(err) {
                if (err) {
                    console.error("스캐너 초기화 오류:", err);

                    if (err.name === 'NotAllowedError') {
                        updateStatus("❌ 카메라 권한이 거부되었습니다. 브라우저 설정에서 카메라 권한을 허용해주세요.");
                    } else if (err.name === 'NotFoundError') {
                        updateStatus("❌ 카메라를 찾을 수 없습니다. 카메라가 연결되어 있는지 확인해주세요.");
                    } else {
                        updateStatus("❌ 스캐너 시작 실패: " + err.message);
                    }
                    return;
                }

                console.log("스캐너 준비 완료");
                Quagga.start();
                scannerIsRunning = true;
                updateStatus("🔍 바코드를 스캔하세요...");

                document.getElementById("startButton").classList.add("hidden");
                document.getElementById("stopButton").classList.remove("hidden");
            });
        }
    }

    function stopScanner() {
        if (scannerIsRunning) {
            Quagga.stop();
            
            var container = document.getElementById("scanner-container");
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            scannerIsRunning = false;
            consecutiveMatches = 0;
            previousBarcode = "";
            updateStatus("");

            document.getElementById("startButton").classList.remove("hidden");
            document.getElementById("stopButton").classList.add("hidden");
        }
    }

    Quagga.onProcessed(function(result) {
        var drawingCtx = Quagga.canvas.ctx.overlay;
        var drawingCanvas = Quagga.canvas.dom.overlay;

        if (!drawingCanvas || !drawingCtx) return;

        drawingCtx.clearRect(
            0,
            0,
            parseInt(drawingCanvas.getAttribute("width")),
            parseInt(drawingCanvas.getAttribute("height"))
        );

        if (result) {
            if (result.boxes) {
                result.boxes
                    .filter(function(box) {
                        return box !== result.box;
                    })
                    .forEach(function(box) {
                        Quagga.ImageDebug.drawPath(
                            box, 
                            { x: 0, y: 1 },
                            drawingCtx, 
                            { color: "green", lineWidth: 2 }
                        );
                    });
            }

            if (result.box) {
                Quagga.ImageDebug.drawPath(
                    result.box, 
                    { x: 0, y: 1 },
                    drawingCtx, 
                    { color: "#00F", lineWidth: 2 }
                );
            }

            if (result.codeResult && result.codeResult.code) {
                Quagga.ImageDebug.drawPath(
                    result.line, 
                    { x: "x", y: "y" },
                    drawingCtx, 
                    { color: "red", lineWidth: 3 }
                );
            }
        }
    });

    Quagga.onDetected(function(result) {
        if (!result || !result.codeResult) return;
        
        var barcodeValue = result.codeResult.code;

        console.log("바코드 값: " + barcodeValue);

        if (barcodeValue === previousBarcode) {
            consecutiveMatches++;
        } else {
            consecutiveMatches = 1;
        }

        previousBarcode = barcodeValue;

        if (consecutiveMatches === targetMatches) {
            alert("바코드 값: " + barcodeValue);
            consecutiveMatches = 0;
            previousBarcode = "";
        }
    });

    window.addEventListener('beforeunload', function() {
        if (scannerIsRunning) {
            Quagga.stop();
        }
    });
    </script>
</body>

</html>