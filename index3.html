<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuaggaJS ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</title>
    <style>
    body {
        background: #f8f8f8;
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.2em;
    }

    #buttonContainer {
        display: flex;
        margin-bottom: 30px;
    }

    button {
        background: #999;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 25px;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    button:hover {
        background: #ddd;
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    #scanner-container {
        position: relative;
        height: calc(100% - 60px);
        /* ì‹œì‘ì¢…ë£Œ ë²„íŠ¼ì„ í‘œì‹œí•˜ê¸° ìœ„í•´ì„œ ìœ„ì¹˜ ê³„ì‚° */
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    #selectedImageContainer {
        margin-top: 10px;
    }

    #status {
        text-align: center;
        color: black;
        margin-top: 20px;
        font-size: 18px;
        font-weight: 500;
        min-height: 30px;
    }

    .hidden {
        display: none;
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }

    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
        }

        .container {
          max-width: 100%;
        }

        #scanner-container {
            border-radius: 10px;
        }
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h1>
        <div id="buttonContainer">
            <button id="startButton" onclick="startScanner()">ì‹œì‘</button>
            <button id="stopButton" onclick="stopScanner()" class="hidden">ì¢…ë£Œ</button>
        </div>
        <div id="scanner-container"></div>
        <div id="status"></div>
        <div id="selectedImageContainer"></div>
    </div>
    <script>
    var scannerIsRunning = false; // ìŠ¤ìºë„ˆ ì‹¤í–‰ìƒíƒœ
    var previousBarcode = ""; // ì •í•©ì„±ì„ ìœ„í•˜ì—¬ ì´ì „ ë°”ì½”ë“œ ìŠ¤ìº”ê°’ì„ ì €ì¥

    function updateStatus(message) {
        document.getElementById("status").textContent = message;
    }

    //ì‹œì‘ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ startScanner í•¨ìˆ˜ í˜¸ì¶œ
    function startScanner() {

        /* scannerIsRunning ì´ˆê¸°ê°’ì´ falseì´ë¯€ë¡œ ë™ì‘, 
           ì¢…ë£Œë²„íŠ¼ì„ í´ë¦­í•˜ë©´ scannerIsRunning=falseë¡œ ë³€ê²½  */
        if (!scannerIsRunning) {

          updateStatus("ì¹´ë©”ë¼ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...");

            // quagga.min.jsì—ì„œ ì„ ì–¸ëœ ìŠ¤ìºë„ˆ(Quagga) ì´ˆê¸°í™” 
            // <video>ì™€ <canvas>ê°€ ìƒì„±ë˜ë©° ê° ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ë¶€ë¶„     
            Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: "#scanner-container", //ë°”ì½”ë“œ ì¸ì‹ ëŒ€ìƒ ì •ë³´(videoì™€ canvasê°€ ì¶”ê°€ë  ë¶€ë¶„) 
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment", // ì ‘ì†í•œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©ê°€ëŠ¥í•œ ì¹´ë©”ë¼
                        },
                    },
                    decoder: {
                        readers: [ // ë°”ì½”ë“œ ìœ í˜• ì¶”ê°€ http://www.gs1kr.org/front/board/appl/GS1Stnd.asp ì°¸ê³ 
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "code_39_vin_reader",
                            "codabar_reader",
                            "upc_reader",
                            "upc_e_reader",
                            "i2of5_reader",
                        ],
                        /* ê°œë°œê³¼ì •ì—ì„œë§Œ ì‚¬ìš©í•˜ê³  ì‹¤ì œë¡œëŠ” ë¹„í™œì„±í™”
                        debug: {
                          showCanvas: true,       //ìŠ¤ìº” ì˜ìƒ ë³´ì—¬ì£¼ëŠ” ìº”ë²„ìŠ¤ í‘œì‹œ
                          showPatches: true,      //ì¶”ì¶œëœ íŒ¨ì¹˜ë¥¼ í‘œì‹œ
                          showFoundPatches: true,   //ê²€ì¶œëœ ë°”ì½”ë“œ íŒ¨ì¹˜ë¥¼ í‘œì‹œ
                          showSkeleton: true,     //ë°”ì½”ë“œ íŒ¨ì¹˜ì˜ ìŠ¤ìº” ë¼ì¸ì„ í‘œì‹œ
                          showLabels: true,       //ë°”ì½”ë“œ íƒ€ì…ê³¼ ìœ„ì¹˜ì— ëŒ€í•œ ë ˆì´ë¸”ì„ í‘œì‹œ
                          showPatchLabels: true,    //íŒ¨ì¹˜ì˜ ë ˆì´ë¸”ì„ í‘œì‹œ
                          showRemainingPatchLabels: true, // ë‚¨ì€ íŒ¨ì¹˜ì˜ ë ˆì´ë¸”ì„ í‘œì‹œ
                          boxFromPatches: {       //íŒ¨ì¹˜ë¡œë¶€í„° ê³„ì‚°ëœ ìƒìì˜ ë³€í™˜ ì •ë³´ë¥¼ í‘œì‹œ
                            showTransformed: true,    //ë³€í™˜ëœ íŒ¨ì¹˜ë¥¼ í‘œì‹œ
                            showTransformedBox: true, //ë³€í™˜ëœ ìƒìë¥¼ í‘œì‹œ
                            showBB: true,       //ë°”ìš´ë”© ë°•ìŠ¤ë¥¼ í‘œì‹œ
                          },              
                        },
                        */
                    },
                },

                //ì—ëŸ¬ ë°œìƒì‹œ
                function(err) {
                    if (err) {
                        console.error("ìŠ¤ìºë„ˆ ì´ˆê¸°í™” ì˜¤ë¥˜:", err);

                        if (err.name === 'NotAllowedError') {
                            updateStatus("âŒ ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                        } else if (err.name === 'NotFoundError') {
                            updateStatus("âŒ ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                        } else {
                            updateStatus("âŒ ìŠ¤ìºë„ˆ ì‹œì‘ ì‹¤íŒ¨: " + err.message);
                        }
                        return;
                    }

                    console.log("ìŠ¤ìºë„ˆ ì¤€ë¹„ ì™„ë£Œ");
                    Quagga.start();
                    scannerIsRunning = true;
                    updateStatus("ğŸ” ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”...");

                    document.getElementById("startButton").classList.add("hidden");
                    document.getElementById("stopButton").classList.remove("hidden");
                });
        }
    }

    /* ì¢…ë£Œë²„íŠ¼ì„ í´ë¦­í•˜ë©´ stopScanner í•¨ìˆ˜ í˜¸ì¶œ */
    function stopScanner() {

        //ìŠ¤ìºë„ˆ ìƒíƒœê°€ trueì´ë¯€ë¡œ ë™ì‘
        if (scannerIsRunning) {

            //ìŠ¤ìºë„ˆ ì¢…ë£Œ
            Quagga.stop();

            //ìŠ¤ìºë„ˆ ìƒíƒœê°’ ë³€ê²½
            scannerIsRunning = false;

            //ì‹œì‘ë²„íŠ¼ í‘œì‹œ (class ê°’ì˜ hidden ì‚­ì œ)
            document.getElementById("startButton").classList.remove("hidden");

            //ì¢…ë£Œë²„íŠ¼ ìˆ¨ê¹€
            document.getElementById("stopButton").classList.add("hidden");
        }
    }

    // ë°”ì½”ë“œ ì¸ì‹ ì„ íƒì‚¬í•­
    // ë°”ì½”ë“œê°€ ì¸ì‹ë˜ëŠ” ë¶€ë¶„(result)ì„ í‘œì‹œ(ë…¹ìƒ‰ì‚¬ê°í˜•ê³¼ ë¹¨ê°„ ê°€ë¡œì¤„)
    Quagga.onProcessed(function(result) {
        //ìº ë²„ìŠ¤ ê°€ë¡œì„¸ë¡œ ê¸¸ì´ ë³€ìˆ˜
        var drawingCtx = Quagga.canvas.ctx.overlay,
            drawingCanvas = Quagga.canvas.dom.overlay;

        if (result) {
            if (result.boxes) {
                //ê·¸ë¦¬ëŠ” ì˜ì—­ ì´ˆê¸°í™”
                drawingCtx.clearRect(
                    0,
                    0,
                    parseInt(drawingCanvas.getAttribute("width")),
                    parseInt(drawingCanvas.getAttribute("height"))
                );

                //ë°”ì½”ë“œ ë¶€ë¶„ë§Œ ì¸ì‹í•˜ì—¬ ë…¹ìƒ‰ ì‚¬ê°í˜• ê·¸ë¦¬ê¸°(ê°€ëŠ¥ì„±ì´ ìˆëŠ” ëª¨ë“  ë¶€ë¶„)
                result.boxes
                    .filter(function(box) {
                        return box !== result.box;
                    })
                    .forEach(function(box) {
                        Quagga.ImageDebug.drawPath(
                            box, { x: 0, y: 1 },
                            drawingCtx, { color: "green", lineWidth: 2 }
                        );
                    });
            }

            //ì¸ì‹í•œ ë°•ìŠ¤ê°€ ë°”ì½”ë“œì¸ì§€ í™•ì¸ ë§ìœ¼ë©´ íŒŒë€ìƒ‰ ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
            if (result.box) {
                Quagga.ImageDebug.drawPath(
                    result.box, { x: 0, y: 1 },
                    drawingCtx, { color: "#00F", lineWidth: 2 }
                );
            }

            //íŒŒë€ìƒ‰ ì‚¬ê°í˜• ì•ˆì˜ ì½”ë“œê°€ ë°”ì½”ë“œê°€ ë§ìœ¼ë©´ ë°œê°„ ê°€ë¡œì¤„ í‘œì‹œ
            if (result.codeResult && result.codeResult.code) {
                Quagga.ImageDebug.drawPath(
                    result.line, { x: "x", y: "y" },
                    drawingCtx, { color: "red", lineWidth: 3 }
                );
            }
        }
    });


    //ë°”ì½”ë“œ ìŠ¤ìº”ê°’ì´ ì—°ì†í•˜ì—¬ targetMatchesê³¼ ê°™ë‹¤ë©´
    //ê²½ê³ ì°½ì— ë°”ì½”ë“œ ê°’ ì¶œë ¥
    var consecutiveMatches = 0; // ì—°ì† ì¼ì¹˜ íšŸìˆ˜
    var targetMatches = 30; // ëª©í‘œ ì¼ì¹˜ íšŸìˆ˜

    Quagga.onDetected(function(result) {
        var barcodeValue = result.codeResult.code;

        console.log("ë°”ì½”ë“œ ê°’: " + barcodeValue);

        if (barcodeValue === previousBarcode) {
            consecutiveMatches++;
        } else {
            consecutiveMatches = 1;
        }

        previousBarcode = barcodeValue;

        if (consecutiveMatches === targetMatches) {
            alert("ë°”ì½”ë“œ ê°’: " + barcodeValue);
        }
    });
    </script>
</body>

</html>